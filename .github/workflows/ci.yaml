name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  quality:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v5
    - name: Rustfmt
      run: cargo fmt --all --check
    - name: Clippy
      run: cargo clippy --all-targets -- -D warnings
    - name: Docs
      run: cargo doc --no-deps

  clippy-feature-matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            args: ""
          - name: blocking-only
            args: "--no-default-features --features blocking-tls-rustls-ring"

    steps:
    - uses: actions/checkout@v5
    - name: Clippy (${{ matrix.name }})
      run: cargo clippy --all-targets ${{ matrix.args }} -- -D warnings

  check-feature-matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            args: ""
          - name: async-only
            args: "--no-default-features --features async-tls-rustls-ring"
          - name: blocking-only
            args: "--no-default-features --features blocking-tls-rustls-ring"
          - name: aws-lc
            args: "--no-default-features --features async-tls-rustls-aws-lc-rs,blocking-tls-rustls-aws-lc-rs"

    steps:
    - uses: actions/checkout@v5
    - name: Check (${{ matrix.name }})
      run: cargo check --verbose ${{ matrix.args }}

  test-feature-matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: default
            args: ""
          - name: async-only
            args: "--no-default-features --features async-tls-rustls-ring"
          - name: blocking-only
            args: "--no-default-features --features blocking-tls-rustls-ring"

    steps:
    - uses: actions/checkout@v5
    - name: Run tests (${{ matrix.name }})
      run: cargo test --verbose ${{ matrix.args }}
